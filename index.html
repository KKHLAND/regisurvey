<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신입생 설문 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Noto Sans KR', arial; 
            margin: 0;
            background-color: #f4f7fa; 
            color: #1e293b;
        }

        .header-section {
            background: linear-gradient(90deg, #0f2b61 0%, #1e4ba1 50%, #0f2b61 100%);
            height: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
            text-align: center;
        }

        .premium-tag {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            color: #451a03;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 10px;
            border-radius: 99px;
            margin-left: 8px;
        }

        .floating-bar {
            margin-top: -60px;
            z-index: 10;
        }

        .main-card {
            background: white;
            border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef2f6;
        }

        .card-stat-1 { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 1px solid #7dd3fc; }
        .card-stat-2 { background: linear-gradient(135deg, #fff1f2 0%, #fecdd3 100%); border: 1px solid #fda4af; }
        .card-stat-3 { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #6ee7b7; }
        .card-stat-4 { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fcd34d; }
        .card-stat-5 { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 1px solid #c084fc; }
        .card-stat-6 { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 1px solid #a5b4fc; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .btn-upload {
            background-color: #3b82f6;
            transition: all 0.2s;
        }
        .btn-upload:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }

        .row-risk { background-color: #fff1f2; }
        .row-sep { background-color: #fffbeb; }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .filter-chip:hover { transform: scale(1.05); }
        .filter-chip.active { border-color: currentColor; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .school-bar {
            height: 28px;
            border-radius: 6px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .school-bar:hover {
            filter: brightness(1.1);
            transform: scaleX(1.02);
        }

        .gender-ring {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-btn {
            transition: all 0.2s;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .sort-btn {
            cursor: pointer;
            user-select: none;
        }
        .sort-btn:hover {
            color: #3b82f6;
        }

        @media print {
            .no-print { display: none !important; }
            .main-card { box-shadow: none; border: 1px solid #e2e8f0; }
            body { background: white; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- 상단 헤더 -->
    <div class="header-section px-4 no-print">
        <div class="flex items-center mb-4">
            <div class="bg-blue-600/30 backdrop-blur-md p-1.5 rounded-lg mr-2 border border-white/20">
                <i class="fa-solid fa-chart-pie text-white text-xs"></i>
            </div>
            <span class="text-white/90 text-xs font-bold tracking-widest uppercase">Student Analytics Studio</span>
            <span class="premium-tag">PREMIUM</span>
        </div>
        <h1 class="text-white text-2xl md:text-4xl font-black mb-4 tracking-tight">신입생 설문 데이터 대시보드</h1>
        <p class="text-white/60 text-sm md:text-base font-medium max-w-xl text-center">
            업로드된 데이터를 시각적으로 분석하고 특이사항을 자동으로 분류합니다.
        </p>
    </div>

    <!-- 플로팅 액션 바 -->
    <div class="max-w-7xl mx-auto px-4 floating-bar no-print">
        <div class="bg-white p-5 rounded-[2rem] shadow-2xl flex flex-wrap items-center justify-between gap-4 border border-slate-100">
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col text-left">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Status</span>
                    <span id="statusText" class="text-sm font-bold text-slate-700">연결 대기 중</span>
                </div>
                <div class="h-8 w-[1px] bg-slate-100 hidden md:block"></div>
                <div class="flex flex-col text-left">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Total / Filtered</span>
                    <span id="recordCountDisplay" class="text-sm font-bold text-blue-600">0 / 0 건</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="document.getElementById('fileInput').click()" class="btn-upload flex items-center gap-2 px-6 py-3 text-white rounded-xl text-sm font-bold shadow-lg">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <span>데이터 업로드</span>
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx, .xls">
                
                <button onclick="resetData()" id="resetBtn" class="hidden flex items-center gap-2 px-4 py-3 text-slate-400 hover:text-rose-500 font-bold text-sm transition-colors">
                    <i class="fa-solid fa-rotate-right"></i>
                    초기화
                </button>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <main class="max-w-7xl mx-auto px-4 mt-10 pb-20">
        
        <!-- 초기 빈 상태 -->
        <div id="empty-state" class="main-card py-24 flex flex-col items-center justify-center text-center">
            <div class="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-6 shadow-inner">
                <i class="fa-solid fa-file-waveform text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">분석할 파일을 준비해주세요</h2>
            <p class="text-slate-400 max-w-sm mx-auto leading-relaxed">
                엑셀 파일(.xlsx)을 업로드하면 성별, 출신학교,<br>특이사항을 자동으로 분석합니다.
            </p>
        </div>

        <!-- 대시보드 뷰 -->
        <div id="dashboard-view" class="hidden space-y-8">
            
            <!-- 지표 그리드 (6개) -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="card-stat-1 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2">총 인원</p>
                    <div class="flex items-center justify-between">
                        <span id="stat-total" class="text-2xl font-black text-blue-900">-</span>
                        <i class="fa-solid fa-users text-blue-400 text-xl"></i>
                    </div>
                </div>
                <div class="card-stat-2 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-rose-500 uppercase tracking-widest mb-2">남학생</p>
                    <div class="flex items-center justify-between">
                        <div>
                            <span id="stat-male" class="text-2xl font-black text-rose-900">-</span>
                            <span id="stat-male-pct" class="text-xs text-rose-600 ml-1">(--%)</span>
                        </div>
                        <i class="fa-solid fa-mars text-blue-400 text-xl"></i>
                    </div>
                </div>
                <div class="card-stat-3 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mb-2">여학생</p>
                    <div class="flex items-center justify-between">
                        <div>
                            <span id="stat-female" class="text-2xl font-black text-emerald-900">-</span>
                            <span id="stat-female-pct" class="text-xs text-emerald-600 ml-1">(--%)</span>
                        </div>
                        <i class="fa-solid fa-venus text-rose-400 text-xl"></i>
                    </div>
                </div>
                <div class="card-stat-4 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-amber-600 uppercase tracking-widest mb-2">출신학교</p>
                    <div class="flex items-center justify-between">
                        <span id="stat-schools" class="text-2xl font-black text-amber-900">-</span>
                        <i class="fa-solid fa-school text-amber-400 text-xl"></i>
                    </div>
                </div>
                <div class="card-stat-5 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest mb-2">분리배정 요청</p>
                    <div class="flex items-center justify-between">
                        <span id="stat-sep" class="text-2xl font-black text-purple-900">-</span>
                        <i class="fa-solid fa-user-group text-purple-400 text-xl"></i>
                    </div>
                </div>
                <div class="card-stat-6 p-5 rounded-2xl transition-transform hover:scale-105">
                    <p class="text-[10px] font-bold text-indigo-600 uppercase tracking-widest mb-2">요청사항 있음</p>
                    <div class="flex items-center justify-between">
                        <span id="stat-notes" class="text-2xl font-black text-indigo-900">-</span>
                        <i class="fa-solid fa-comment-dots text-indigo-400 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- 필터 섹션 -->
            <div class="main-card p-6 no-print">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <h4 class="font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-filter text-blue-500"></i> 필터 및 검색
                    </h4>
                    <button onclick="clearAllFilters()" class="text-xs text-slate-400 hover:text-rose-500 font-bold transition-colors">
                        <i class="fa-solid fa-xmark mr-1"></i> 필터 초기화
                    </button>
                </div>
                
                <!-- 검색 -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-5">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-300"></i>
                        <input type="text" id="searchInput" placeholder="이름 / 연락처 검색" class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 outline-none">
                    </div>
                    <select id="filterGender" class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none cursor-pointer">
                        <option value="All">성별: 전체</option>
                        <option value="남성">남학생</option>
                        <option value="여성">여학생</option>
                    </select>
                    <select id="filterSchool" class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none cursor-pointer">
                        <option value="All">출신학교: 전체</option>
                    </select>
                    <select id="filterCategory" class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none cursor-pointer">
                        <option value="All">분류: 전체</option>
                        <option value="SepRequest">분리배정 요청</option>
                        <option value="HasNote">요청사항 있음</option>
                        <option value="Normal">일반</option>
                    </select>
                    <select id="filterContact" class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none cursor-pointer">
                        <option value="All">연락처: 전체</option>
                        <option value="HasPhone">본인연락처 있음</option>
                        <option value="NoPhone">본인연락처 없음</option>
                        <option value="HasParent">보호자연락처 있음</option>
                        <option value="NoParent">보호자연락처 없음</option>
                    </select>
                </div>

                <!-- 빠른 필터 칩 -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-xs text-slate-400 font-bold mr-2 self-center">빠른 필터:</span>
                    <button onclick="quickFilter('all')" class="filter-chip bg-slate-100 text-slate-600 active" data-filter="all">
                        <i class="fa-solid fa-list mr-1"></i> 전체
                    </button>
                    <button onclick="quickFilter('sep')" class="filter-chip bg-amber-100 text-amber-700" data-filter="sep">
                        <i class="fa-solid fa-user-group mr-1"></i> 분리배정
                    </button>
                    <button onclick="quickFilter('note')" class="filter-chip bg-purple-100 text-purple-700" data-filter="note">
                        <i class="fa-solid fa-comment mr-1"></i> 요청사항
                    </button>
                    <button onclick="quickFilter('wonmuk')" class="filter-chip bg-blue-100 text-blue-700" data-filter="wonmuk">
                        <i class="fa-solid fa-school mr-1"></i> 원묵중
                    </button>
                    <button onclick="quickFilter('other')" class="filter-chip bg-emerald-100 text-emerald-700" data-filter="other">
                        <i class="fa-solid fa-building mr-1"></i> 타학교
                    </button>
                </div>
            </div>

            <!-- 시각화 영역 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 성별 분포 (도넛) -->
                <div class="main-card p-6">
                    <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-pink-500"></i> 성별 분포
                    </h4>
                    <div class="flex flex-col items-center">
                        <div class="relative" style="width: 200px; height: 200px;">
                            <canvas id="genderPieChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="genderCenterTotal" class="text-2xl font-black text-slate-800">-</span>
                                <span class="text-xs text-slate-400">명</span>
                            </div>
                        </div>
                        <div class="flex gap-6 mt-4">
                            <div class="text-center">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span class="text-sm font-semibold text-slate-600">남학생</span>
                                </div>
                                <p class="text-lg font-black text-blue-600"><span id="legendMale">-</span>명</p>
                                <p class="text-xs text-slate-400"><span id="legendMalePct">-</span>%</p>
                            </div>
                            <div class="text-center">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 rounded-full bg-rose-500"></div>
                                    <span class="text-sm font-semibold text-slate-600">여학생</span>
                                </div>
                                <p class="text-lg font-black text-rose-600"><span id="legendFemale">-</span>명</p>
                                <p class="text-xs text-slate-400"><span id="legendFemalePct">-</span>%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 출신학교 분포 (전체) -->
                <div class="main-card p-6 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-bar text-blue-500"></i> 출신 중학교 분포
                            <span id="schoolCount" class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0개교</span>
                        </h4>
                        <div class="flex gap-2">
                            <button onclick="toggleSchoolView('chart')" id="btnChartView" class="text-xs px-3 py-1.5 bg-blue-500 text-white rounded-lg font-bold">차트</button>
                            <button onclick="toggleSchoolView('table')" id="btnTableView" class="text-xs px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200">표</button>
                        </div>
                    </div>
                    <div id="schoolChartView" class="overflow-x-auto custom-scrollbar" style="max-height: 320px;">
                        <div id="schoolBarsContainer" class="space-y-2 min-w-[400px]"></div>
                    </div>
                    <div id="schoolTableView" class="hidden overflow-auto custom-scrollbar" style="max-height: 320px;">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b border-slate-100">
                                    <th class="text-left py-2 px-3 font-bold text-slate-500">학교명</th>
                                    <th class="text-center py-2 px-3 font-bold text-slate-500">인원</th>
                                    <th class="text-center py-2 px-3 font-bold text-slate-500">비율</th>
                                    <th class="text-center py-2 px-3 font-bold text-blue-500">남</th>
                                    <th class="text-center py-2 px-3 font-bold text-rose-500">여</th>
                                </tr>
                            </thead>
                            <tbody id="schoolTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 내보내기 버튼 -->
            <div class="flex flex-wrap gap-3 justify-end no-print">
                <button onclick="exportCSV()" class="export-btn flex items-center gap-2 px-5 py-2.5 bg-emerald-500 text-white rounded-xl text-sm font-bold shadow-lg">
                    <i class="fa-solid fa-file-csv"></i> CSV 내보내기
                </button>
                <button onclick="exportPDF()" class="export-btn flex items-center gap-2 px-5 py-2.5 bg-rose-500 text-white rounded-xl text-sm font-bold shadow-lg">
                    <i class="fa-solid fa-file-pdf"></i> PDF 내보내기
                </button>
                <button onclick="window.print()" class="export-btn flex items-center gap-2 px-5 py-2.5 bg-slate-600 text-white rounded-xl text-sm font-bold shadow-lg">
                    <i class="fa-solid fa-print"></i> 인쇄
                </button>
            </div>

            <!-- 학생 명단 테이블 -->
            <div class="main-card overflow-hidden" id="studentListCard">
                <div class="p-6 border-b border-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50/30">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                        <i class="fa-solid fa-address-book text-blue-600"></i> 학생 상세 명단
                        <span id="filteredCount" class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0명</span>
                    </h3>
                    <div class="flex items-center gap-3 text-xs text-slate-400">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-100 border border-amber-300"></span> 분리배정</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-purple-100 border border-purple-300"></span> 요청사항</span>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[600px] custom-scrollbar">
                    <table class="w-full text-left" id="studentTable">
                        <thead class="bg-slate-50/80 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                    <span class="sort-btn" onclick="sortTable('index')"># <i class="fa-solid fa-sort text-slate-300"></i></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                    <span class="sort-btn" onclick="sortTable('name')">성명 <i class="fa-solid fa-sort text-slate-300"></i></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">생년월일</th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest text-center border-b border-slate-100">
                                    <span class="sort-btn" onclick="sortTable('gender')">성별 <i class="fa-solid fa-sort text-slate-300"></i></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                    <span class="sort-btn" onclick="sortTable('school')">출신학교 <i class="fa-solid fa-sort text-slate-300"></i></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">본인연락처</th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">보호자연락처</th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">보호자(추가)</th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest text-center border-b border-slate-100 whitespace-nowrap">분리배정</th>
                                <th class="px-4 py-3 text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">요청사항</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="divide-y divide-slate-50 text-base"></tbody>
                    </table>
                </div>
            </div>

            <!-- 요약 통계 -->
            <div class="main-card p-6">
                <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-chart-simple text-indigo-500"></i> 요약 통계
                </h4>
                <div id="summaryStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"></div>
            </div>

        </div>
    </main>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-bold text-slate-800">데이터를 분석 중입니다...</p>
        </div>
    </div>

    <!-- 요청사항 상세 모달 -->
    <div id="noteModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4" onclick="closeNoteModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h4 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-comment-dots text-purple-500"></i>
                    <span id="modalStudentName">학생명</span>의 요청사항
                </h4>
                <button onclick="closeNoteModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <p id="modalNoteContent" class="text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end">
                <button onclick="closeNoteModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <script>
        let students = [];
        let filteredStudents = [];
        let genderChart = null;
        let sortConfig = { key: 'index', asc: true };

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            fileInput?.addEventListener('change', handleFileUpload);
            
            ['searchInput', 'filterGender', 'filterSchool', 'filterCategory', 'filterContact'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', applyFilters);
                document.getElementById(id)?.addEventListener('input', applyFilters);
            });

            // ESC 키로 모달 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeNoteModal();
                }
            });
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading(true);
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    processData(json);
                } catch (err) {
                    console.error(err);
                    alert("파일을 읽는 중 오류가 발생했습니다.");
                } finally {
                    showLoading(false);
                    e.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function formatPhone(value) {
            if (!value) return '';
            let phone = String(value).trim();
            
            // 숫자만 추출
            phone = phone.replace(/[^0-9]/g, '');
            
            if (!phone) return '';
            
            // 앞에 0이 없으면 추가 (엑셀에서 숫자로 저장된 경우)
            if (phone.length === 10 && !phone.startsWith('0')) {
                phone = '0' + phone;
            }
            
            // 전화번호 형식 변환
            if (phone.length === 11 && phone.startsWith('010')) {
                return phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (phone.length === 10) {
                return phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            
            return phone;
        }

        function processData(rows) {
            const uniqueMap = new Map();
            
            rows.forEach((row, idx) => {
                const name = String(row['성명'] || '').trim();
                if (!name) return;
                
                const dob = String(row['생년월일(8자리)'] || '').trim();
                const key = `${name}_${dob}`;
                
                if (uniqueMap.has(key)) return;
                
                const gender = String(row['성별'] || '').trim();
                let school = String(row['출신중학교'] || '').trim();
                school = school.replace(/중학교$|중$/, '').trim();
                
                const sepRequest = String(row['고입 배정 신청 시 분리배정 요청 여부'] || '').trim();
                const notes = String(row['학급 편성 시 요청사항'] || '').trim();
                
                // 분리배정 요청: 'O' 또는 '요청'이 포함되고, '미요청', 'X', '없음'이 아닌 경우
                const isSepRequest = (sepRequest === 'O' || sepRequest === '분리배정 요청') && 
                                     !sepRequest.includes('미요청') && 
                                     sepRequest !== 'X' && 
                                     !sepRequest.includes('없음');
                const hasNote = notes && !['없음', '없습니다', '없다', '없어용', 'X', '없어요', '없슴'].some(x => notes.includes(x));

                const phone = formatPhone(row['본인연락처(휴대폰)']);
                const parentPhone = formatPhone(row['보호자연락처(휴대폰)']);
                const parentPhone2 = formatPhone(row['보호자연락처(추가)']);

                uniqueMap.set(key, {
                    index: uniqueMap.size + 1,
                    name,
                    dob,
                    gender,
                    school,
                    phone,
                    parentPhone,
                    parentPhone2,
                    sepRequest: isSepRequest,
                    sepRequestRaw: sepRequest,
                    notes: hasNote ? notes : '',
                    hasNote
                });
            });

            students = Array.from(uniqueMap.values());
            
            if (students.length > 0) {
                document.getElementById('empty-state')?.classList.add('hidden');
                document.getElementById('resetBtn')?.classList.remove('hidden');
                document.getElementById('dashboard-view')?.classList.remove('hidden');
                document.getElementById('statusText').innerText = "분석 완료";
                
                populateSchoolFilter();
                applyFilters();
            } else {
                alert("데이터를 추출하지 못했습니다.");
            }
        }

        function populateSchoolFilter() {
            const schoolMap = {};
            students.forEach(s => schoolMap[s.school] = (schoolMap[s.school] || 0) + 1);
            const sorted = Object.entries(schoolMap).sort((a, b) => b[1] - a[1]);
            
            const select = document.getElementById('filterSchool');
            select.innerHTML = '<option value="All">출신학교: 전체</option>';
            sorted.forEach(([school, count]) => {
                select.innerHTML += `<option value="${school}">${school}중 (${count}명)</option>`;
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const gender = document.getElementById('filterGender').value;
            const school = document.getElementById('filterSchool').value;
            const category = document.getElementById('filterCategory').value;
            const contact = document.getElementById('filterContact').value;

            filteredStudents = students.filter(s => {
                if (search && !s.name.toLowerCase().includes(search) && 
                    !s.phone.includes(search) && 
                    !s.parentPhone.includes(search) && 
                    !s.parentPhone2.includes(search)) return false;
                if (gender !== 'All' && s.gender !== gender) return false;
                if (school !== 'All' && s.school !== school) return false;
                if (category === 'SepRequest' && !s.sepRequest) return false;
                if (category === 'HasNote' && !s.hasNote) return false;
                if (category === 'Normal' && (s.sepRequest || s.hasNote)) return false;
                if (contact === 'HasPhone' && !s.phone) return false;
                if (contact === 'NoPhone' && s.phone) return false;
                if (contact === 'HasParent' && !s.parentPhone && !s.parentPhone2) return false;
                if (contact === 'NoParent' && (s.parentPhone || s.parentPhone2)) return false;
                return true;
            });

            render();
        }

        function quickFilter(type) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-filter="${type}"]`)?.classList.add('active');
            
            document.getElementById('searchInput').value = '';
            document.getElementById('filterGender').value = 'All';
            document.getElementById('filterSchool').value = 'All';
            document.getElementById('filterCategory').value = 'All';
            document.getElementById('filterContact').value = 'All';

            switch(type) {
                case 'sep':
                    document.getElementById('filterCategory').value = 'SepRequest';
                    break;
                case 'note':
                    document.getElementById('filterCategory').value = 'HasNote';
                    break;
                case 'wonmuk':
                    document.getElementById('filterSchool').value = '원묵';
                    break;
                case 'other':
                    filteredStudents = students.filter(s => s.school !== '원묵');
                    render();
                    return;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterGender').value = 'All';
            document.getElementById('filterSchool').value = 'All';
            document.getElementById('filterCategory').value = 'All';
            document.getElementById('filterContact').value = 'All';
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-filter="all"]')?.classList.add('active');
            applyFilters();
        }

        function render() {
            updateStats();
            renderGenderChart();
            renderSchoolChart();
            renderTable();
            renderSummary();
        }

        function updateStats() {
            const total = students.length;
            const male = students.filter(s => s.gender === '남성').length;
            const female = total - male;
            const schools = new Set(students.map(s => s.school)).size;
            const sepCount = students.filter(s => s.sepRequest).length;
            const noteCount = students.filter(s => s.hasNote).length;

            document.getElementById('stat-total').innerText = total + '명';
            document.getElementById('stat-male').innerText = male;
            document.getElementById('stat-male-pct').innerText = `(${Math.round(male/total*100)}%)`;
            document.getElementById('stat-female').innerText = female;
            document.getElementById('stat-female-pct').innerText = `(${Math.round(female/total*100)}%)`;
            document.getElementById('stat-schools').innerText = schools + '개';
            document.getElementById('stat-sep').innerText = sepCount + '건';
            document.getElementById('stat-notes').innerText = noteCount + '건';
            document.getElementById('recordCountDisplay').innerText = `${total} / ${filteredStudents.length} 건`;
            document.getElementById('filteredCount').innerText = filteredStudents.length + '명';
        }

        function renderGenderChart() {
            const male = filteredStudents.filter(s => s.gender === '남성').length;
            const female = filteredStudents.length - male;
            const total = filteredStudents.length;

            document.getElementById('genderCenterTotal').innerText = total;
            document.getElementById('legendMale').innerText = male;
            document.getElementById('legendMalePct').innerText = total ? Math.round(male/total*100) : 0;
            document.getElementById('legendFemale').innerText = female;
            document.getElementById('legendFemalePct').innerText = total ? Math.round(female/total*100) : 0;

            const ctx = document.getElementById('genderPieChart').getContext('2d');
            if (genderChart) genderChart.destroy();
            
            genderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['남학생', '여학생'],
                    datasets: [{
                        data: [male, female],
                        backgroundColor: ['#3b82f6', '#f43f5e'],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderSchoolChart() {
            const schoolMap = {};
            const schoolGender = {};
            
            filteredStudents.forEach(s => {
                schoolMap[s.school] = (schoolMap[s.school] || 0) + 1;
                if (!schoolGender[s.school]) schoolGender[s.school] = { male: 0, female: 0 };
                if (s.gender === '남성') schoolGender[s.school].male++;
                else schoolGender[s.school].female++;
            });

            const sorted = Object.entries(schoolMap).sort((a, b) => b[1] - a[1]);
            const maxCount = sorted[0]?.[1] || 1;

            document.getElementById('schoolCount').innerText = sorted.length + '개교';

            // 막대 차트
            const container = document.getElementById('schoolBarsContainer');
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
            
            container.innerHTML = sorted.map(([school, count], i) => {
                const pct = Math.round(count / filteredStudents.length * 100);
                const width = (count / maxCount * 100);
                const color = colors[i % colors.length];
                const g = schoolGender[school];
                return `
                    <div class="flex items-center gap-3 py-1">
                        <div class="w-20 text-xs font-semibold text-slate-600 truncate" title="${school}중">${school}중</div>
                        <div class="flex-1 relative">
                            <div class="school-bar" style="width: ${width}%; background: ${color};" onclick="filterBySchool('${school}')">
                                <div class="absolute inset-y-0 left-2 flex items-center text-xs font-bold text-white">
                                    ${count}명 (${pct}%)
                                </div>
                            </div>
                        </div>
                        <div class="w-16 text-[10px] text-slate-400 text-right">
                            <span class="text-blue-500">${g.male}</span>/<span class="text-rose-500">${g.female}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // 테이블
            const tbody = document.getElementById('schoolTableBody');
            tbody.innerHTML = sorted.map(([school, count], i) => {
                const pct = (count / filteredStudents.length * 100).toFixed(1);
                const g = schoolGender[school];
                return `
                    <tr class="hover:bg-slate-50 cursor-pointer" onclick="filterBySchool('${school}')">
                        <td class="py-2 px-3 font-semibold">${school}중</td>
                        <td class="py-2 px-3 text-center font-bold">${count}명</td>
                        <td class="py-2 px-3 text-center">${pct}%</td>
                        <td class="py-2 px-3 text-center text-blue-600 font-semibold">${g.male}</td>
                        <td class="py-2 px-3 text-center text-rose-600 font-semibold">${g.female}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterBySchool(school) {
            document.getElementById('filterSchool').value = school;
            applyFilters();
        }

        function toggleSchoolView(view) {
            const chartView = document.getElementById('schoolChartView');
            const tableView = document.getElementById('schoolTableView');
            const btnChart = document.getElementById('btnChartView');
            const btnTable = document.getElementById('btnTableView');

            if (view === 'chart') {
                chartView.classList.remove('hidden');
                tableView.classList.add('hidden');
                btnChart.className = 'text-xs px-3 py-1.5 bg-blue-500 text-white rounded-lg font-bold';
                btnTable.className = 'text-xs px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200';
            } else {
                chartView.classList.add('hidden');
                tableView.classList.remove('hidden');
                btnTable.className = 'text-xs px-3 py-1.5 bg-blue-500 text-white rounded-lg font-bold';
                btnChart.className = 'text-xs px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200';
            }
        }

        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.asc = !sortConfig.asc;
            } else {
                sortConfig.key = key;
                sortConfig.asc = true;
            }
            
            filteredStudents.sort((a, b) => {
                let va = a[key], vb = b[key];
                if (typeof va === 'string') va = va.toLowerCase();
                if (typeof vb === 'string') vb = vb.toLowerCase();
                if (va < vb) return sortConfig.asc ? -1 : 1;
                if (va > vb) return sortConfig.asc ? 1 : -1;
                return 0;
            });
            
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = filteredStudents.map((s, i) => {
                let rowClass = 'hover:bg-slate-50';
                if (s.sepRequest) rowClass = 'bg-amber-50';
                else if (s.hasNote) rowClass = 'bg-purple-50';
                
                return `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-4 py-3 text-slate-400 font-mono text-sm">${i + 1}</td>
                        <td class="px-4 py-3 font-bold text-slate-900 text-base whitespace-nowrap">${s.name}</td>
                        <td class="px-4 py-3 text-slate-500 font-mono text-sm">${s.dob}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded-lg text-xs font-black ${s.gender === '남성' ? 'bg-blue-100 text-blue-600' : 'bg-rose-100 text-rose-600'}">
                                ${s.gender === '남성' ? '남' : '여'}
                            </span>
                        </td>
                        <td class="px-4 py-3 font-semibold text-slate-600 text-sm">${s.school}중</td>
                        <td class="px-4 py-3 text-slate-600 font-mono text-sm">${s.phone || '-'}</td>
                        <td class="px-4 py-3 text-slate-600 font-mono text-sm">${s.parentPhone || '-'}</td>
                        <td class="px-4 py-3 text-slate-600 font-mono text-sm">${s.parentPhone2 || '-'}</td>
                        <td class="px-4 py-3 text-center">
                            ${s.sepRequest ? '<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold">요청</span>' : '<span class="text-slate-300">-</span>'}
                        </td>
                        <td class="px-4 py-3 max-w-xs">
                            ${s.notes ? `<div class="text-sm text-slate-600 truncate cursor-pointer hover:text-purple-600 transition-colors note-cell" data-name="${s.name}" data-note-idx="${i}" title="클릭하여 전체 내용 보기">${s.notes.substring(0, 50)}${s.notes.length > 50 ? '...' : ''} <i class="fa-solid fa-expand text-xs text-slate-400 ml-1"></i></div>` : '<span class="text-slate-300">-</span>'}
                        </td>
                    </tr>
                `;
            }).join('');

            // 요청사항 클릭 이벤트 바인딩
            document.querySelectorAll('.note-cell').forEach(el => {
                el.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.noteIdx);
                    const student = filteredStudents[idx];
                    if (student) {
                        openNoteModal(student.name, student.notes);
                    }
                });
            });
        }

        function renderSummary() {
            const total = students.length;
            const male = students.filter(s => s.gender === '남성').length;
            const female = total - male;
            const wonmuk = students.filter(s => s.school === '원묵').length;
            const other = total - wonmuk;
            const sepCount = students.filter(s => s.sepRequest).length;
            const noteCount = students.filter(s => s.hasNote).length;

            document.getElementById('summaryStats').innerHTML = `
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-1">남녀 비율</p>
                    <p class="font-bold text-slate-800">${male}:${female} (${Math.round(male/total*100)}:${Math.round(female/total*100)})</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-1">원묵중 비율</p>
                    <p class="font-bold text-slate-800">${wonmuk}명 (${Math.round(wonmuk/total*100)}%)</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-1">타학교 출신</p>
                    <p class="font-bold text-slate-800">${other}명 (${Math.round(other/total*100)}%)</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-1">특이사항 비율</p>
                    <p class="font-bold text-slate-800">${sepCount + noteCount}건 (${Math.round((sepCount+noteCount)/total*100)}%)</p>
                </div>
            `;
        }

        function exportCSV() {
            const headers = ['번호', '성명', '생년월일', '성별', '출신학교', '본인연락처', '보호자연락처', '보호자연락처(추가)', '분리배정요청', '요청사항'];
            const rows = filteredStudents.map((s, i) => [
                i + 1,
                s.name,
                s.dob,
                s.gender,
                s.school + '중',
                s.phone,
                s.parentPhone,
                s.parentPhone2,
                s.sepRequest ? 'O' : '',
                s.notes
            ]);

            const BOM = '\uFEFF';
            const csvContent = BOM + [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `신입생명단_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        async function exportPDF() {
            showLoading(true);
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // 가로 모드
                
                pdf.setFont('helvetica');
                
                const pageWidth = 297;
                const margin = 10;
                let y = 15;

                // 제목
                pdf.setFontSize(16);
                pdf.text('신입생 명단', pageWidth / 2, y, { align: 'center' });
                y += 8;

                pdf.setFontSize(9);
                pdf.text(`생성일: ${new Date().toLocaleDateString('ko-KR')} | 총 ${filteredStudents.length}명`, pageWidth / 2, y, { align: 'center' });
                y += 10;

                // 테이블 헤더
                const colWidths = [8, 22, 22, 12, 28, 28, 28, 28, 12, 50];
                const headers = ['#', 'Name', 'DOB', 'Gender', 'School', 'Phone', 'Parent1', 'Parent2', 'Sep', 'Notes'];
                
                pdf.setFillColor(240, 240, 240);
                pdf.rect(margin, y - 4, pageWidth - margin * 2, 7, 'F');
                
                pdf.setFontSize(7);
                let x = margin;
                headers.forEach((h, i) => {
                    pdf.text(h, x + 1, y);
                    x += colWidths[i];
                });
                y += 6;

                // 데이터 행
                pdf.setFontSize(6);
                filteredStudents.forEach((s, i) => {
                    if (y > 200) {
                        pdf.addPage();
                        y = 15;
                    }

                    x = margin;
                    const row = [
                        String(i + 1),
                        s.name,
                        s.dob,
                        s.gender === '남성' ? 'M' : 'F',
                        s.school,
                        s.phone || '',
                        s.parentPhone || '',
                        s.parentPhone2 || '',
                        s.sepRequest ? 'O' : '',
                        (s.notes || '').substring(0, 25)
                    ];

                    row.forEach((cell, ci) => {
                        pdf.text(String(cell).substring(0, 15), x + 1, y);
                        x += colWidths[ci];
                    });
                    y += 4;
                });

                pdf.save(`신입생명단_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (err) {
                console.error(err);
                alert('PDF 생성 중 오류가 발생했습니다.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function openNoteModal(name, note) {
            document.getElementById('modalStudentName').innerText = name;
            document.getElementById('modalNoteContent').innerText = note;
            document.getElementById('noteModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeNoteModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('noteModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function resetData() {
            if (confirm("모든 데이터를 초기화할까요?")) location.reload();
        }
    </script>
</body>
</html>
